var appClass,initializers;initializers=[],appClass=window.MKConsole||(window.MKConsole={}),appClass.App=Backbone.View.extend({el:$(document),initialize:function(){var t,e,n,i;for(this.pubsub=_.extend({},Backbone.Events),this.commands={},i=[],e=0,n=initializers.length;n>e;e++)t=initializers[e],i.push(t(this));return i}}),appClass.onInit=function(t){return initializers.push(t)};var HelpQueue,Request;Request=Backbone.Model.extend({}),HelpQueue=Backbone.Collection.extend({initialize:function(t,e){return this.app=e.app,this.listenTo(this.app.pubsub,"stream:help_queue_requests",this.add)}}),MKS.onInit(function(t){return g.userIsAdmin?t.helpQueue||(t.helpQueue=new HelpQueue([],{app:t})):void 0});var ChatRoom,Message;Message=Backbone.Model.extend({}),ChatRoom=Backbone.Collection.extend({model:Message,comparator:function(t){return-t.time},initialize:function(t,e){return this.roomId=e.roomId,this.listenTo(this.app.pubsub,"stream:chat_message",this.addMessage)},addMessage:function(t,e){return t===this.roomId?this.add(e):void 0}}),MKS.onInit(function(t){var e;return t.rooms||(t.rooms={}),e=function(e,n){var i;return i=t.rooms[e],i?i.add(n):(i=t.rooms[e]=new ChatRoom(n,{app:t,roomId:e}),t.pubsub.trigger("chat_room_init",i))},t.pubsub.on("whoami",function(t){var n,i,a,s;a=t.chat_history,s=[];for(i in a)n=a[i],s.push(e(i,n));return s}),t.pubsub.on("stream:join_room",function(n,i){return console.log("Joining room:",n),e(n,i),t.roomViews[n].view()})}),MKS.Prefs=Backbone.Model.extend({initialize:function(){return this.on("change",function(){return function(t){var e,n,i,a;i=t.changed,a=[];for(e in i)n=i[e],console.log("Updating pref:",e,n),a.push(app.stream.send("update_pref",e,n));return a}}(this))}});var Stream,__slice=[].slice;Stream=Backbone.View.extend({initialize:function(){return this.lastConnected=null,this.heartbeatTimeout=null,_.bindAll(this,"heartbeat"),this.listenTo(this.app.pubsub,"stream:auth_success",function(t){return function(){return $("body").addClass("online"),t.heartbeat(),t.send("whoami",t.lastConnected||"")}}(this)),this.listenTo(this.app.pubsub,"stream:the_chosen_one",function(t){return function(e){var n,i,a,s;if(e.teams)for(t.app.teams=e.teams,t.app.teamNames={},s=e.teams,i=0,a=s.length;a>i;i++)n=s[i],t.app.teamNames[n.id]=n.name;return e.prefs&&(t.app.prefs=new MKS.Prefs(e.prefs)),t.app.pubsub.trigger("whoami",e)}}(this))},connect:function(){var t;return this.socket=t=new ReconnectingWebSocket("ws://"+g.streamUrl),t.onopen=function(){return console.log("stream:open"),t.send("2|auth|"+g.sid)},t.onmessage=function(t){return function(e){var n,i,a,s,o;"1|x"!==e.data&&console.log("stream:message",e.data),o=e.data,n=parseInt(o.split("|",1)[0]),i=o.substring(o.indexOf("|")+1),a=_.splitPayload(i,n),a[0]="stream:"+a[0];try{s=a.length-1,a[s]=JSON.parse(a[s])}catch(r){e=r}return t.app.pubsub.trigger.apply(t.app.pubsub,a)}}(this),t.onclose=function(t){return function(){return t.lastConnected=Date.now(),console.log("stream:close"),$("body").removeClass("online"),clearTimeout(t.heartbeatTimeout)}}(this),t.onerror=function(t,e){return console.log("stream:error",t,e)}},send:function(){var t,e;return e=1<=arguments.length?__slice.call(arguments,0):[],t=e.length-1,"object"==typeof e[t]&&(e[t]=JSON.stringify(e[t])),console.log("Sending",e.join("|")),this.socket.send(""+e.length+"|"+e.join("|"))},heartbeat:function(){return this.socket.send("2|echo|x"),this.heartbeatTimeout=setTimeout(this.heartbeat,9847)}}),MKS.onInit(function(t){return t.stream=new Stream({app:t}),t.stream.connect()});var ConsoleTabView,ConsoleView,defaultTabOptions,tabTemplate,template;template=_.template('<div class="{{ className }}" data-tab-id="{{ tabId }}">{{ content }}</div>'),tabTemplate=function(t,e,n){return null==n&&(n=""),template({tabId:t,content:n,className:e})},defaultTabOptions={addContentMethod:"append"},ConsoleTabView=Backbone.View.extend({el:"#console .tabs"}),ConsoleView=Backbone.View.extend({el:"#console",events:{"click .toggle-interface":"toggle","keypress .interface input":"handleInput","click .interface .tab":"onTabClick"},initialize:function(){return this.input=this.$(".interface input"),this.tabs={},this.tabs.main={id:"main",tabDiv:this.$(".interface .tabs .tab[data-tab-id='main']"),output:this.$('.interface .output-scroller [data-tab-id="main"]'),addContentMethod:"append",options:_.defaults({},defaultTabOptions)},this.currentTab=this.tabs.main,this.scroller=this.$(".interface .output-scroller"),this.$el.show(),$(document).on("keypress",function(t){return function(e){return e.ctrlKey&&47===e.keyCode?t.toggle():void 0}}(this))},puts:function(t){var e;return e=this.currentTab.addContentMethod,this.currentTab.output[e]("<pre>"+t+"</pre>"),this.scroll()},addTab:function(t,e){var n;if(!this.tabs[t])return n={id:t,tabDiv:$(tabTemplate(t,"tab",e.label)),output:$(tabTemplate(t,"output")),options:_.defaults(e,defaultTabOptions)},n.addContentMethod=n.options.addContentMethod,this.$(".interface .tabs").append(n.tabDiv),this.$(".interface .output-scroller").append(n.output),this.tabs[t]=n},viewTab:function(t){return this.currentTab.output.hide(),this.currentTab=this.tabs[t],this.currentTab.output.show(),this.scroll(),this.$(".tabs .tab").removeClass("active"),this.tabs[t].tabDiv.addClass("active")},append:function(t,e,n){var i,a,s;return s=n.showInMain,a=n.replace,i=a?"html":this.currentTab.addContentMethod,this.tabs[t].output[i](e),s&&(i=this.tabs.main.addContentMethod,this.tabs.main.output[i](e)),this.scroll()},scroll:function(){return"prepend"!==this.currentTab.addContentMethod?this.scroller.scrollTop(this.currentTab.output[0].scrollHeight):void 0},toggle:function(){return this.$(".interface").toggle(),$("body").toggleClass("console"),this.$(".interface").is(":visible")?this.$(".interface input").focus():void 0},onTabClick:function(t){return this.viewTab(t.currentTarget.getAttribute("data-tab-id"))},handleInput:function(t){var e,n,i,a;if(13===t.keyCode)return a=this.input.val().split(" "),"/"===a[0][0]?(n=a.shift().substring(1),e=a):(n="chat",e=["send",void 0].concat(a)),e.unshift(this.app),this.input.val(""),i=this.app.commands[n]||this.app.commandAliases[n],i?i.run.apply(i,e):this.puts("`/"+n+"` is not a command.")}}),MKS.onInit(function(t){return t.console=new ConsoleView({app:t})});var DashboardView;DashboardView=Backbone.View.extend({el:"#console .widgets",initialize:function(){return this.widgets=[],this.listenTo(this.app.pubsub,"dashboard:load",this.loadWidget),this.$el.show()},loadWidget:function(){return this.widgets.push(widgets),this.render()},render:function(){return this.widgets.each(function(t){return t.render()})}}),MKS.onInit(function(t){return t.dashboard=new DashboardView({app:t})});